import streamlit as st
import pdfplumber
import pandas as pd
from PIL import Image
import numpy as np

# -----------------------------
# ุฅุนุฏุงุฏ OpenAI (ูุณุฎุฉ 0.28)
# -----------------------------
try:
    import openai
    OPENAI_API_KEY = st.secrets.get("OPENAI_API_KEY", None)
    if OPENAI_API_KEY:
        openai.api_key = OPENAI_API_KEY
    else:
        OPENAI_API_KEY = None
except Exception:
    OPENAI_API_KEY = None

# -----------------------------
# ุฅุนุฏุงุฏุงุช ุนุงูุฉ ููุชุทุจูู
# -----------------------------
st.set_page_config(
    page_title="ูุธุงู ุชุฏููู ุงููููุฌูุฉ ูุฑุจุท ุงููุฏุฎูุงุช",
    layout="wide"
)

st.title("๐ ูุธุงู ุชุฏููู ุงููููุฌูุฉ ูุฑุจุทูุง ุจุงููุฏุฎูุงุช")
st.markdown(
    """
ูุฐุง ุงููููุฐุฌ ูุณูุญ ูู ุจุฑูุน:
- ููู **ูููุฌูุฉ ุงูุชูููู** ุจุตูุบุฉ PDF  
- ููู **ุงูููุงุฆู ุงููุงููุฉ / ุงููุณุจ** ุจุตูุบุฉ Excel  
- ูููุงุช **ุงูุญูููุฉ** ุจุตูุบุฉ ุตูุฑ (ุนุฏุฏ ุบูุฑ ูุญุฏูุฏ)  
- ูููุงุช **ุงููุดุงุฑูุน** ุจุตูุบุฉ ุตูุฑ (ุนุฏุฏ ุบูุฑ ูุญุฏูุฏ)  
- ูููุงุช **ุงูุชูููู ุจุงููุฌูู** ุจุตูุบุฉ ุตูุฑ (ุนุฏุฏ ุบูุฑ ูุญุฏูุฏ)

ุซู ูููู ุจุงุณุชุฎุฑุงุฌ ุงููุตูุต ูุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉุ  
ููู ุญุงู ุชููุฑ OpenAI API Key ูููู ุจุชูููุฏ **ุชูุฑูุฑ ุชุฏููู ุขูู ูุงูู** ุจุฃุณููุจ ูุฏูู ูุงูู.
"""
)

st.markdown("---")

# -----------------------------
# ุฏูุงู ูุณุงุนุฏุฉ
# -----------------------------
def extract_text_from_pdf(uploaded_file) -> str:
    """ุงุณุชุฎุฑุงุฌ ุงููุต ูู ููู PDF ุจุงุณุชุฎุฏุงู pdfplumber."""
    if uploaded_file is None:
        return ""
    text_pages = []
    with pdfplumber.open(uploaded_file) as pdf:
        for page in pdf.pages:
            page_text = page.extract_text() or ""
            text_pages.append(page_text)
    full_text = "\n".join(text_pages)
    return full_text.strip()


def read_excel_file(uploaded_file) -> pd.DataFrame:
    """ูุฑุงุกุฉ ููู Excel ูุฅุฑุฌุงุน DataFrame."""
    if uploaded_file is None:
        return pd.DataFrame()
    try:
        df = pd.read_excel(uploaded_file)
        return df
    except Exception as e:
        st.error(f"ุฎุทุฃ ูู ูุฑุงุกุฉ ููู Excel: {e}")
        return pd.DataFrame()


def count_and_preview_images(image_files):
    """ุนุฑุถ ุนุฏุฏ ุงูุตูุฑ ูุจุนุถ ุงููุนุงููุงุช ุงููุตุบุฑุฉ."""
    if not image_files:
        st.info("ูู ูุชู ุฑูุน ุฃู ูููุงุช ูู ูุฐุง ุงููุณู ุญุชู ุงูุขู.")
        return

    st.write(f"ุนุฏุฏ ุงููููุงุช ุงููุฑููุนุฉ: **{len(image_files)}**")
    cols = st.columns(4)
    for idx, img_file in enumerate(image_files[:8]):  # ูุนุฑุถ ุจุญุฏ ุฃูุตู 8 ุตูุฑ ูููุนุงููุฉ
        with cols[idx % 4]:
            try:
                image = Image.open(img_file)
                st.image(image, caption=img_file.name, use_column_width=True)
            except Exception as e:
                st.warning(f"ุชุนุฐูุฑ ุนุฑุถ ุงูุตูุฑุฉ: {img_file.name} - {e}")


def simple_text_summary(text: str, max_chars: int = 1500) -> str:
    """ุชูุฎูุต ุจุณูุท ุฌุฏุงู ุจูุต ุงููุต (ููุงู ูุคูุช ูุจู ุฅุฏุฎุงู AI)."""
    if not text:
        return "ูุง ููุฌุฏ ูุต ูุงุณุชุฎูุงุต ููุฎุต ููู."
    trimmed = text[:max_chars]
    if len(text) > max_chars:
        trimmed += "\n\n[ุชู ูุต ุงููุต ููุนุฑุถ ููุท...]"
    return trimmed


def detect_available_years(df: pd.DataFrame):
    """
    ุงูุชุดุงู ุงูุฃุนูุฏุฉ ุงูุชู ุชูุซู ุณููุงุช (ูุซู 2023ุ 2024) ูุงูุชุฃูุฏ ูู ุฃู ูุฌููุนูุง ููุณ ุตูุฑุงู ุจุงููุงูู.
    ูุนูุฏ ูุงุฆูุฉ ุจุงูุณููุงุช ุงูุชู ุชุญุชูู ุนูู ุจูุงูุงุช ูุนููุฉ.
    """
    if df.empty:
        return []

    year_cols = []
    for c in df.columns:
        try:
            # ูุญุงูู ุชุญููู ุงุณู ุงูุนููุฏ ุฅูู ุฑูู (ุณูุฉ)
            int(c)
            year_cols.append(c)
        except:
            continue

    non_zero_years = []
    for y in year_cols:
        try:
            col = df[y].replace([np.nan], 0).astype(float)
            total = col.abs().sum()
            if total != 0:
                non_zero_years.append(y)
        except Exception:
            continue

    return non_zero_years


def summarize_financials(df: pd.DataFrame, available_years) -> str:
    """
    ุฅูุดุงุก ููุฎุต ูุตู ูุจุณุท ููุจูุงูุงุช ุงููุงููุฉ:
    - ุนุฏุฏ ุงูุตููู ูุงูุฃุนูุฏุฉ
    - ุฃูู ุงูุฃุนูุฏุฉ
    - ูู ุงูุดุฑูุฉ ุณูุฉ ูุงุญุฏุฉ: ูุฐูุฑ ุฐูู
    - ูู ุฃูุซุฑ ูู ุณูุฉ: ูุฐูุฑ ุฐูู
    """
    if df.empty:
        return "ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ูุชุงุญุฉ."

    rows, cols = df.shape
    summary_lines = []
    summary_lines.append(f"ุนุฏุฏ ุงูุตููู: {rows} ุตูุ ูุนุฏุฏ ุงูุฃุนูุฏุฉ: {cols} ุนููุฏ.\n")

    # ูุตู ุนุฏุฏ ุงูุณููุงุช
    if len(available_years) == 0:
        summary_lines.append(
            "ูู ูุชู ุงูุชุนุฑู ุนูู ุฃุนูุฏุฉ ุชูุซู ุณููุงุช ูุงููุฉ ุชุญุชูู ุนูู ุจูุงูุงุช ูุนููุฉ "
            "(ูุฏ ุชููู ุงูุดุฑูุฉ ุฌุฏูุฏุฉ ุฃู ุฃู ุงูุฃุนูุฏุฉ ููุณุช ูุณูุงุฉ ูู 2023ุ 2024 ูุซูุงู)."
        )
    elif len(available_years) == 1:
        summary_lines.append(
            f"ุชุจููู ุฃู ุงูุดุฑูุฉ ูุฏููุง ุณูุฉ ูุงููุฉ ูุงุญุฏุฉ ูุชุงุญุฉ ููู ({available_years[0]}). "
            "ุจุงูุชุงูู ูุง ูููู ุงุญุชุณุงุจ ูุคุดุฑุงุช ููู ุชุงุฑูุฎูุฉุ ูุณูุชู ุงูุงุนุชูุงุฏ ุนูู ูุฐู ุงูุณูุฉ ููุท."
        )
    else:
        years_sorted = sorted(available_years)
        summary_lines.append(
            "ุชุชููุฑ ุจูุงูุงุช ูุงููุฉ ูุนุฏุฉ ุณููุงุช ูุชุชุงููุฉุ ููุง ูุณูุญ ุจุงุญุชุณุงุจ ูุคุดุฑุงุช ุงูููู ุจูู ุงููุชุฑุงุช. "
            f"ุงูุณูุฉ ุงูุฃููู ุงููุชุงุญุฉ: {years_sorted[0]}ุ ูุขุฎุฑ ุณูุฉ ูุชุงุญุฉ: {years_sorted[-1]}."
        )

    summary_lines.append("\nุฃูู ุงูุฃุนูุฏุฉ ุงููุชุงุญุฉ ูู ุงูููู:")
    summary_lines.append(", ".join([str(c) for c in df.columns[:10]]))

    # ูุญุงููุฉ ุงุณุชุฎุฑุงุฌ ุจุนุถ ุงููุคุดุฑุงุช ูู ูุงูุช ููุงู ุฃุนูุฏุฉ ุฑูููุฉ
    numeric_cols = df.select_dtypes(include="number").columns.tolist()
    if numeric_cols:
        summary_lines.append("\n\nุจุนุถ ุงูุฃุนูุฏุฉ ุงูุนุฏุฏูุฉ ููุคุดุฑุงุชูุง ุงูุชูุฑูุจูุฉ:")
        for col in numeric_cols[:5]:
            try:
                col_series = df[col].dropna()
                if not col_series.empty:
                    summary_lines.append(
                        f"- {col}: ูุชูุณุท {col_series.mean():,.2f}ุ "
                        f"ุฃุนูู ูููุฉ {col_series.max():,.2f}ุ ุฃูู ูููุฉ {col_series.min():,.2f}"
                    )
            except Exception:
                continue

    return "\n".join(summary_lines)


def summarize_images_info(governance_images, project_images, rating_images) -> str:
    """ููุฎุต ูุตู ุนู ูููุงุช ุงูุญูููุฉ ูุงููุดุงุฑูุน ูุงููุฌูู (ุจุฏูู ูุฑุงุกุฉ ูุญุชูู ุงูุตูุฑ ุญุงููุงู)."""
    lines = []
    lines.append(f"ุนุฏุฏ ูููุงุช ุงูุญูููุฉ ุงููุฑููุนุฉ: {len(governance_images) if governance_images else 0}.")
    if governance_images:
        lines.append("ุฃูุซูุฉ ุนูู ุฃุณูุงุก ูููุงุช ุงูุญูููุฉ:")
        for f in governance_images[:5]:
            lines.append(f"- {f.name}")

    lines.append(f"\nุนุฏุฏ ูููุงุช ุงููุดุงุฑูุน ุงููุฑููุนุฉ: {len(project_images) if project_images else 0}.")
    if project_images:
        lines.append("ุฃูุซูุฉ ุนูู ุฃุณูุงุก ูููุงุช ุงููุดุงุฑูุน:")
        for f in project_images[:5]:
            lines.append(f"- {f.name}")

    lines.append(f"\nุนุฏุฏ ูููุงุช ุงูุชูููู ุจุงููุฌูู ุงููุฑููุนุฉ: {len(rating_images) if rating_images else 0}.")
    if rating_images:
        lines.append("ุฃูุซูุฉ ุนูู ุฃุณูุงุก ูููุงุช ุงูุชูููู:")
        for f in rating_images[:5]:
            lines.append(f"- {f.name}")

    lines.append(
        "\nููุงุญุธุฉ: ูู ูุฐู ุงููุณุฎุฉ ูุชู ุงุณุชุฎุฏุงู ุงููุนูููุงุช ุงููุตููุฉ (ุนุฏุฏ ุงููููุงุช ูุฃุณูุงุคูุง) "
        "ููููู ูุณุชูุจูุงู ุฅุถุงูุฉ ูุฑุงุกุฉ ูุญุชูู ุงูุตูุฑ (OCR / Vision) ูุฑุจุท ุฃูุซุฑ ุฏูุฉ."
    )

    return "\n".join(lines)


def generate_ai_audit_comment(methodology_text, financial_summary, images_summary, single_year_mode, base_year) -> str:
    """ุชูููุฏ ุชูุฑูุฑ ุชุฏููู ุขูู ุจุงุณุชุฎุฏุงู OpenAI (ุฅู ุชููุฑ ุงูููุชุงุญ)."""
    if not OPENAI_API_KEY:
        return (
            "ูู ูุชู ุถุจุท ููุชุงุญ OpenAI API ูู ุฅุนุฏุงุฏุงุช Secretsุ "
            "ูุฐูู ูุนุฑุถ ุงููุธุงู ุชุนูููุงู ูุจุฏุฆูุงู ููุท. "
            "ูููู ุฅุถุงูุฉ ุงูููุชุงุญ ูุชูุนูู ุชูุฑูุฑ ุงูุชุฏููู ุงูุขูู."
        )

    if methodology_text:
        methodology_excerpt = methodology_text[:6000]
    else:
        methodology_excerpt = "ูุง ููุฌุฏ ูุต ูููููุฌูุฉ."

    # ูุต ุชูุถูุญู ุฎุงุต ุจุนุฏุฏ ุงูุณููุงุช
    if single_year_mode and base_year is not None:
        years_note = (
            f"ููุงุญุธุฉ ูููุฉ: ุงูุดุฑูุฉ ูุฏููุง ุณูุฉ ูุงููุฉ ูุงุญุฏุฉ ููุท ({base_year}) ุจุจูุงูุงุช ูุนููุฉุ "
            "ููู ุฃูุฑ ูุนุชุงุฏ ูู ุงูุดุฑูุงุช ุญุฏูุซุฉ ุงูุชุฃุณูุณ. ุจูุงุกู ุนูู ุฐููุ ุชู ุงูุงุนุชูุงุฏ ุนูู ูุฐู ุงูุณูุฉ "
            "ูู ุงูุญูู ุนูู ุงููุถุน ุงููุงูู ุงูุญุงูู ุฏูู ุงุญุชุณุงุจ ูุคุดุฑุงุช ููู ุชุงุฑูุฎูุฉ."
        )
    else:
        years_note = (
            "ูุชุถุญ ูู ุงูุจูุงูุงุช ุงููุงููุฉ ุฃู ููุงู ุฃูุซุฑ ูู ุณูุฉ ูุชุงุญุฉุ "
            "ููุง ูุณูุญ ุจุฏุฑุงุณุฉ ุงุชุฌุงูุงุช ุงูููู ูุงูุชุบูุฑ ูู ุงูุฃุฏุงุก ุงููุงูู ุนุจุฑ ุงููุชุฑุงุช."
        )

    prompt = f"""
ุฃูุช ูุฏูู ูุงูู ูุนูู ูู ููุงูุฉ ุชุตููู ููููุงูููู.
ูุฏูู ุงููุนูููุงุช ุงูุชุงููุฉ:

ุฃููุงู: ูุต ุงููููุฌูุฉ (ููุชุทู ุฑุฆูุณู):
----------------
{methodology_excerpt}
----------------

ุซุงููุงู: ููุฎุต ุงูุจูุงูุงุช ุงููุงููุฉ ูุงููุณุจ ุงููุณุชุฎุฑุฌุฉ ูู ููู Excel:
----------------
{financial_summary}
----------------

ุซุงูุซุงู: ููุงุญุธุฉ ุญูู ูุฏู ุชููุฑ ุงูุณููุงุช ุงููุงููุฉ:
----------------
{years_note}
----------------

ุฑุงุจุนุงู: ููุฎุต ุนู ูููุงุช ุงูุญูููุฉ ูุงููุดุงุฑูุน ูุงูุชูููู ุจุงููุฌูู (ุฃุณูุงุก ุงููููุงุช ูุนุฏุฏูุง):
----------------
{images_summary}
----------------

ุงููุทููุจ ููู ุฅุนุฏุงุฏ **ุชูุฑูุฑ ุชุฏููู ุงุฆุชูุงูู** ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุจุฃุณููุจ ูููู ูููุธูุ ูุชุถูู ุงูุฃูุณุงู ุงูุชุงููุฉ ุจุงูุชุฑุชูุจ:

1. **ููุฎุต ุชูููุฐู (Executive Summary)**:
   - ููุถุญ ุจุฅูุฌุงุฒ ุงููุฏู ูู ุงููุฑุงุฌุนุฉุ ูุญุฏุงุซุฉ ุงูุดุฑูุฉ ูู ุนุฏููุงุ ูุทุจูุนุฉ ุงูุจูุงูุงุช ุงููุชุงุญุฉ (ุณูุฉ ูุงุญุฏุฉ ุฃู ุฃูุซุฑ).
2. **ูููุฌูุฉ ุงูุชูููู**:
   - ููุฑุฉ ูุตูุฑุฉ ุชุดุฑุญ ููู ุชูุญุชุณุจ ุงููุฌูู ูููุงู ูููููุฌูุฉุ ุฏูู ููู ุงููุต ุญุฑููุงูุ ุจู ุจุตูุงุบุฉ ููุฎุตุฉ ููุงุถุญุฉ.
3. **ูุฑุงุฌุนุฉ ุงูููุงุฆู ุงููุงููุฉ ูุงููุณุจ**:
   - ุชุญููู ุนุงู ูุฌูุฏุฉ ุงููุฑูุฒ ุงููุงููุ ูุณุชูู ุงูุณูููุฉุ ุงูุฑุจุญูุฉ (ุฅู ุฃููู)ุ ูููููุฉ ุงูุฏููู.
   - ูู ุญุงู ูุฌูุฏ ุณูุฉ ูุงุญุฏุฉ ููุทุ ูุถูุญ ุฃู ุงูุญูู ูุจูู ุนูู ุณูุฉ ุชุฃุณูุณูุฉ ุจุฏูู ุณุฌู ุชุงุฑูุฎู.
4. **ูุฑุงุฌุนุฉ ุงูุญูููุฉ ูุงููุดุงุฑูุน**:
   - ุงูุชุนููู ุนูู ููุงูุฉ ุนุฏุฏ ุงููููุงุช ุงููุฑููุนุฉ ููุญูููุฉ ูุงููุดุงุฑูุน ูู ุญูุซ ููููุง ุฃุฏูุฉ ุฏุงุนูุฉ ููุชูููู.
   - ููุงุญุธุงุช ุนุงูุฉ ุญูู ูุถูุญ ุงูุชูุซูู ููุฌูุฏ ูุง ูููู ูู ุงููุนูููุงุช ูุงุชุฎุงุฐ ูุฑุงุฑ.
5. **ุงุชุณุงู ุงูุชูููู ุจุงููุฌูู ูุน ุงููููุฌูุฉ ูุงููุฏุฎูุงุช**:
   - ููุงูุดุฉ ูุจุฏุฆูุฉ ุญูู ูุง ุฅุฐุง ูุงูุช ุฏุฑุฌุฉ ุงููุฌูู ุชุจุฏู ููุทููุฉ ุจุงูุงุณุชูุงุฏ ุฅูู ุงูููุงุฆู ุงููุงููุฉ ูุงูุญูููุฉ ูุงููุดุงุฑูุน
     ูุงููููุฏ ุงููุชุนููุฉ ุจุนุฏู ุชููุฑ ุฃูุซุฑ ูู ุณูุฉ (ุฅู ูุงูุช ุงูุดุฑูุฉ ุฌุฏูุฏุฉ).
6. **ุฎูุงุตุฉ ูุชูุตูุงุช**:
   - ุฅุดุงุฑุฉ ุฅูู ูุง ุฅุฐุง ูุงู ุงูุชูููู ุงูุญุงูู ูููู ุงุนุชุจุงุฑู ุชุตูููุงู ุฃูููุงู (Provisional) ุฎุงุตุฉ ูู ุงูุดุฑูุงุช ุญุฏูุซุฉ ุงูุชุฃุณูุณ.
   - ุชูุตูุงุช ูุชุญุณูู ุฌูุฏุฉ ุฅุฏุฎุงู ุงูุจูุงูุงุช ููุณุชูุฏุงุช ุงูุญูููุฉ ูุงููุดุงุฑูุน.
   - ููุฑุฉ ุฎุชุงููุฉ ุจุตูุงุบุฉ ุฑุณููุฉ ุตุงูุญุฉ ููุถุนูุง ูู ุชูุฑูุฑ ูุฑูุน ููุฅุฏุงุฑุฉ ุงูุนููุง.

ุงุญุฑุต ุนูู:
- ุฃู ูููู ุงูุฃุณููุจ ุฑุณูู ูููููุ ููุฃูู ุตุงุฏุฑ ูู ูุฏูู ูุงูู.
- ุงุณุชุฎุฏุงู ุนุจุงุฑุงุช ูุซู "ุงุณุชูุงุฏุงู ุฅูู ุงูุจูุงูุงุช ุงููุชุงุญุฉ" ุจุฏูุงู ูู ุงูุฌุฒู ุงููุทููุ ุฎุงุตุฉ ุนูุฏ ูุญุฏูุฏูุฉ ุงูุณููุงุช.
- ุฃูุง ุชูู ุตูุงุบุฉ ุงูุชูุฑูุฑ ุนู 4 ููุฑุงุช ููุง ุชุฒูุฏ ุนู 8 ููุฑุงุช ูุตูุฑุฉ ูููุธูุฉ.
"""

    try:
        response = openai.ChatCompletion.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "ุฃูุช ูุฏูู ูุงูู ูุญุชุฑู ููุชุฎุตุต ูู ุชูููู ุดุฑูุงุช ุงูููุงููุงุช."},
                {"role": "user", "content": prompt},
            ],
            temperature=0.3,
        )
        content = response.choices[0].message["content"].strip()
        return content
    except Exception as e:
        return f"ุชุนุฐุฑ ุชูููุฏ ุชูุฑูุฑ ุงูุชุฏููู ุงูุขูู ุจุณุจุจ ุฎุทุฃ ูู ุงุณุชุฏุนุงุก OpenAI: {e}"


# -----------------------------
# ูุงุฌูุฉ ุฑูุน ุงููููุงุช
# -----------------------------
col1, col2 = st.columns(2)

with col1:
    st.subheader("๐ ููู ุงููููุฌูุฉ (PDF)")
    methodology_pdf = st.file_uploader("ุงุฑูุน ููู ุงููููุฌูุฉ ุจุตูุบุฉ PDF", type=["pdf"])

    st.subheader("๐ ููู ุงูููุงุฆู ุงููุงููุฉ / ุงููุณุจ (Excel)")
    financial_excel = st.file_uploader("ุงุฑูุน ููู Excel ููููุงุฆู ุงููุงููุฉ / ุงููุณุจ", type=["xlsx", "xls"])

with col2:
    st.subheader("๐ ูููุงุช ุงูุญูููุฉ (ุตูุฑ)")
    governance_images = st.file_uploader(
        "ุงุฑูุน ูููุงุช ุงูุญูููุฉ (ุนุฏุฏ ุบูุฑ ูุญุฏูุฏ)",
        type=["png", "jpg", "jpeg"],
        accept_multiple_files=True
    )

    st.subheader("๐ ูููุงุช ุงููุดุงุฑูุน (ุตูุฑ)")
    project_images = st.file_uploader(
        "ุงุฑูุน ูููุงุช ุงููุดุงุฑูุน (ุนุฏุฏ ุบูุฑ ูุญุฏูุฏ)",
        type=["png", "jpg", "jpeg"],
        accept_multiple_files=True
    )

    st.subheader("โญ ูููุงุช ุงูุชูููู ุจุงููุฌูู (ุตูุฑ)")
    rating_images = st.file_uploader(
        "ุงุฑูุน ูููุงุช ูุฎุฑุฌุงุช ุงููุฌูู / ุงูุชูููู (ุนุฏุฏ ุบูุฑ ูุญุฏูุฏ)",
        type=["png", "jpg", "jpeg"],
        accept_multiple_files=True
    )

st.markdown("---")

# ุฒุฑ ุจุฏุก ุงูุชุญููู
start = st.button("๐ ุจุฏุก ุงูุชุญููู ูุฅุนุฏุงุฏ ุชูุฑูุฑ ุงูุชุฏููู")

if start:
    # ---------------------------------
    # 1) ูุนุงูุฌุฉ ููู ุงููููุฌูุฉ PDF
    # ---------------------------------
    st.header("1๏ธโฃ ุชุญููู ููู ุงููููุฌูุฉ (PDF)")
    methodology_text = extract_text_from_pdf(methodology_pdf)
    if methodology_text:
        st.success("ุชู ุงุณุชุฎุฑุงุฌ ูุต ุงููููุฌูุฉ ุจูุฌุงุญ.")
        st.markdown("**ููุชุทู ูู ูุต ุงููููุฌูุฉ:**")
        st.text_area("ูุต ุงููููุฌูุฉ (ููุชุทู)", simple_text_summary(methodology_text), height=250)
    else:
        st.warning("ูู ูุชู ุงุณุชุฎุฑุงุฌ ูุต ูู ููู ุงููููุฌูุฉุ ุชุฃูุฏ ูู ุฑูุน ููู ุตุญูุญ.")

    st.markdown("---")

    # ---------------------------------
    # 2) ูุนุงูุฌุฉ ููู ุงูููุงุฆู ุงููุงููุฉ Excel
    # ---------------------------------
    st.header("2๏ธโฃ ุชุญููู ููู ุงูููุงุฆู ุงููุงููุฉ / ุงููุณุจ (Excel)")
    financial_df = read_excel_file(financial_excel)

    # ูุดู ุงูุณููุงุช ุงููุชุงุญุฉ (ููู ุฌุฏุงู ูุญุงูุฉ ุงูุดุฑูุงุช ุงูุฌุฏูุฏุฉ ุฐุงุช ุณูุฉ ูุงุญุฏุฉ ููุท)
    available_years = detect_available_years(financial_df)
    if len(available_years) == 1:
        single_year_mode = True
        base_year = available_years[0]
    else:
        single_year_mode = False
        base_year = None

    if not financial_df.empty:
        st.success("ุชู ูุฑุงุกุฉ ููู Excel ุจูุฌุงุญ.")
        st.write("**ุฑุคูุณ ุงูุฃุนูุฏุฉ:**")
        st.write(list(financial_df.columns))
        st.write("**ุฃูู 5 ุตููู ูู ุงูุจูุงูุงุช:**")
        st.dataframe(financial_df.head())
    else:
        st.warning("ูู ูุชู ูุฑุงุกุฉ ุจูุงูุงุช ูู ููู Excelุ ุชุฃูุฏ ูู ุฑูุน ููู ุตุญูุญ.")

    st.markdown("---")

    # ---------------------------------
    # 3) ูุนุงููุฉ ูููุงุช ุงูุญูููุฉ / ุงููุดุงุฑูุน / ุงููุฌูู
    # ---------------------------------
    st.header("3๏ธโฃ ูููุงุช ุงูุญูููุฉ")
    count_and_preview_images(governance_images)

    st.markdown("---")
    st.header("4๏ธโฃ ูููุงุช ุงููุดุงุฑูุน")
    count_and_preview_images(project_images)

    st.markdown("---")
    st.header("5๏ธโฃ ูููุงุช ุงูุชูููู ุจุงููุฌูู")
    count_and_preview_images(rating_images)

    st.markdown("---")

    # ---------------------------------
    # 4) ุชูุฑูุฑ ุชุฏููู ุขูู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู (ูู ุญุงู ุชููุฑ ุงูููุชุงุญ)
    # ---------------------------------
    st.header("6๏ธโฃ ุชูุฑูุฑ ุชุฏููู ุขูู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู")

    financial_summary = summarize_financials(financial_df, available_years)
    images_summary = summarize_images_info(governance_images, project_images, rating_images)

    with st.expander("๐๏ธ ุนุฑุถ ููุฎุต ุงูุจูุงูุงุช ุงูุชู ุณูุชู ุฅุฑุณุงููุง ุฅูู ูููุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู", expanded=False):
        st.subheader("ููุฎุต ุงูุจูุงูุงุช ุงููุงููุฉ")
        st.text(financial_summary)
        st.subheader("ููุฎุต ูููุงุช ุงูุญูููุฉ ูุงููุดุงุฑูุน ูุงููุฌูู")
        st.text(images_summary)

    if OPENAI_API_KEY:
        st.info("ูุชู ุงูุขู ุงุณุชุฎุฏุงู OpenAI ูุชูููุฏ ุชูุฑูุฑ ุชุฏููู ุขูู ุงุนุชูุงุฏุงู ุนูู ุงููููุฌูุฉ ูุงูุจูุงูุงุช ุงููุชุงุญุฉ...")
        ai_comment = generate_ai_audit_comment(
            methodology_text,
            financial_summary,
            images_summary,
            single_year_mode,
            base_year
        )
        st.subheader("๐ ุชูุฑูุฑ ุงูุชุฏููู ุงูุขูู (ุฌุงูุฒ ูููุณุฎ ูู ุชูุฑูุฑ ุฑุณูู):")
        st.write(ai_comment)
    else:
        st.warning(
            "ูู ูุชู ุงูุนุซูุฑ ุนูู ููุชุงุญ OpenAI API ูู Secrets.\n"
            "ููุญุตูู ุนูู ุชูุฑูุฑ ุชุฏููู ุขููุ ุฃุถู ุงูููุชุงุญ ุชุญุช ุงูุงุณู OPENAI_API_KEY ูู ุฅุนุฏุงุฏุงุช ุงูุชุทุจูู."
        )
